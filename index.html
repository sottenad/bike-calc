<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cycling Climb Calculator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            accent: '#f97316'
          }
        }
      }
    }
  </script>
  <style>
    /* Custom styles */
    .rpm-ideal { @apply text-green-600 font-semibold; }
    .rpm-ok { @apply text-yellow-600; }
    .rpm-hard { @apply text-red-600; }

    details summary { cursor: pointer; }
    details summary::-webkit-details-marker { display: none; }

    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type="number"] { -moz-appearance: textfield; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="max-w-4xl mx-auto px-4 py-8">
    <!-- Header -->
    <header class="text-center mb-8">
      <h1 class="text-3xl font-bold text-gray-900 mb-2">Cycling Climb Calculator</h1>
      <p class="text-gray-600">Estimate climb times, analyze power-to-weight, and understand your gearing</p>
    </header>

    <!-- Input Section -->
    <section class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold text-gray-900">Your Stats</h2>
        <!-- Unit Toggle -->
        <div class="flex items-center gap-2">
          <span id="kgLabel" class="text-sm font-medium text-orange-600">kg</span>
          <button type="button" id="unitToggle" role="switch" aria-checked="false"
            class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent bg-orange-500 transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2">
            <span id="toggleKnob" class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out translate-x-0"></span>
          </button>
          <span id="lbLabel" class="text-sm font-medium text-gray-400">lb</span>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Rider Weight -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Rider Weight</label>
          <div class="flex">
            <input type="number" id="riderWeight" value="70" min="30" max="500" step="0.1"
              class="flex-1 rounded-l-lg border border-r-0 border-gray-300 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent">
            <span id="riderWeightUnit" class="rounded-r-lg border border-gray-300 px-4 py-2 bg-gray-50 text-gray-600 min-w-[3rem] text-center">kg</span>
          </div>
        </div>

        <!-- Bike Weight -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Bike Weight</label>
          <div class="flex">
            <input type="number" id="bikeWeight" value="8" min="1" max="50" step="0.1"
              class="flex-1 rounded-l-lg border border-r-0 border-gray-300 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent">
            <span id="bikeWeightUnit" class="rounded-r-lg border border-gray-300 px-4 py-2 bg-gray-50 text-gray-600 min-w-[3rem] text-center">kg</span>
          </div>
        </div>

        <!-- Power -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Sustained Power</label>
          <div class="flex">
            <input type="number" id="power" value="200" min="50" max="500" step="1"
              class="flex-1 rounded-l-lg border border-r-0 border-gray-300 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent">
            <span class="rounded-r-lg border border-gray-300 px-4 py-2 bg-gray-50 text-gray-600">W</span>
          </div>
        </div>
      </div>

      <!-- Power to Weight Display -->
      <div class="mt-6 p-4 bg-orange-50 rounded-lg border border-orange-200">
        <div class="flex items-center justify-between">
          <span class="text-gray-700 font-medium">Power-to-Weight Ratio</span>
          <span class="text-2xl font-bold text-orange-600" id="powerToWeight">2.86 W/kg</span>
        </div>
        <div class="mt-2 text-sm text-gray-600" id="pwrCategory">Recreational rider</div>
      </div>
    </section>

    <!-- Climb Selection -->
    <section class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Select Climb</h2>

      <select id="climbSelect" class="w-full rounded-lg border border-gray-300 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-orange-500 mb-4">
        <optgroup label="Famous Climbs">
          <option value="alpe-dhuez">Alpe d'Huez (France)</option>
          <option value="galibier">Col du Galibier (France)</option>
          <option value="haleakala">Haleakala (Hawaii, USA)</option>
          <option value="ventoux">Mont Ventoux - Bédoin (France)</option>
          <option value="tourmalet">Col du Tourmalet (France)</option>
        </optgroup>
        <optgroup label="Custom">
          <option value="custom">Enter your own climb...</option>
        </optgroup>
      </select>

      <!-- Custom Climb Inputs (hidden by default) -->
      <div id="customClimbInputs" class="hidden mb-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
        <div class="text-sm text-blue-700 mb-3">
          Enter any two values and the third will be calculated automatically.
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Distance</label>
            <div class="flex">
              <input type="number" id="customDistance" placeholder="e.g. 15" min="0.1" step="0.1"
                class="flex-1 rounded-l-lg border border-r-0 border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent">
              <span class="rounded-r-lg border border-gray-300 px-3 py-2 bg-gray-50 text-gray-600">km</span>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Elevation Gain</label>
            <div class="flex">
              <input type="number" id="customElevation" placeholder="e.g. 1000" min="1" step="1"
                class="flex-1 rounded-l-lg border border-r-0 border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent">
              <span class="rounded-r-lg border border-gray-300 px-3 py-2 bg-gray-50 text-gray-600">m</span>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Avg Gradient</label>
            <div class="flex">
              <input type="number" id="customGradient" placeholder="e.g. 7" min="0.1" max="45" step="0.1"
                class="flex-1 rounded-l-lg border border-r-0 border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent">
              <span class="rounded-r-lg border border-gray-300 px-3 py-2 bg-gray-50 text-gray-600">%</span>
            </div>
          </div>
        </div>
        <div id="customCalcHint" class="mt-2 text-xs text-gray-500 hidden"></div>
      </div>

      <!-- Climb Info Card -->
      <div id="climbInfoCard" class="bg-gray-50 rounded-lg p-4 border border-gray-200">
        <div id="climbHeader" class="flex items-start justify-between mb-4">
          <div>
            <h3 class="text-xl font-bold text-gray-900" id="climbName">Alpe d'Huez</h3>
            <p class="text-gray-600 text-sm" id="climbLocation">Isère, French Alps</p>
          </div>
          <span class="px-3 py-1 bg-red-100 text-red-700 text-sm font-medium rounded-full" id="climbCategory">HC</span>
        </div>

        <div class="grid grid-cols-3 gap-4 mb-4">
          <div class="text-center">
            <div class="text-2xl font-bold text-gray-900" id="climbDistance">13.8</div>
            <div class="text-sm text-gray-500">km</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-gray-900" id="climbElevation">1,122</div>
            <div class="text-sm text-gray-500">m gain</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-gray-900" id="climbGradient">8.1</div>
            <div class="text-sm text-gray-500">% avg</div>
          </div>
        </div>

        <!-- Estimated Time -->
        <div class="bg-white rounded-lg p-4 border border-gray-200">
          <div class="text-center">
            <div class="text-sm text-gray-500 mb-1">Estimated Climb Time</div>
            <div class="text-4xl font-bold text-orange-600" id="estimatedTime">1:23:45</div>
            <div class="text-sm text-gray-500 mt-2">
              Average speed: <span class="font-medium text-gray-700" id="avgSpeed">9.9 km/h</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Formula Details (Collapsible) -->
    <section class="bg-white rounded-xl shadow-sm border border-gray-200 mb-6">
      <details class="group">
        <summary class="p-6 flex items-center justify-between">
          <h2 class="text-lg font-semibold text-gray-900">Calculation Details</h2>
          <svg class="w-5 h-5 text-gray-500 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </summary>

        <div class="px-6 pb-6 border-t border-gray-100 pt-4">
          <!-- Power to Weight Formula -->
          <div class="mb-6">
            <h3 class="font-medium text-gray-900 mb-2">Power-to-Weight Ratio</h3>
            <div class="bg-gray-50 rounded-lg p-4 font-mono text-sm overflow-x-auto">
              <div class="text-gray-600">W/kg = Power (W) ÷ Rider Mass (kg)</div>
              <div class="text-orange-600 mt-2" id="pwrFormula">W/kg = 200 W ÷ 70 kg = 2.86 W/kg</div>
            </div>
          </div>

          <!-- Climb Time Formula -->
          <div class="mb-6">
            <h3 class="font-medium text-gray-900 mb-2">Climb Time Estimation</h3>
            <div class="bg-gray-50 rounded-lg p-4 font-mono text-sm overflow-x-auto">
              <div class="text-gray-600 mb-2">Physics Model:</div>
              <div class="text-gray-700 mb-3">
                P × η = v × (m×g×sin(θ) + Crr×m×g×cos(θ) + 0.5×CdA×ρ×v²)
              </div>
              <div class="text-gray-600 text-xs mb-4">
                Where: P = power, η = drivetrain efficiency (0.97), v = velocity, m = total mass,<br>
                g = 9.81 m/s², θ = road angle, Crr = rolling resistance (0.004),<br>
                CdA = aerodynamic drag area (0.35 m²), ρ = air density (1.2 kg/m³)
              </div>
              <div class="border-t border-gray-200 pt-3 mt-3">
                <div class="text-gray-600">With your values:</div>
                <div class="text-orange-600 mt-2 whitespace-pre-wrap" id="climbFormula">
                  Total mass = 70 + 8 = 78 kg
                  Power input = 200 W × 0.97 = 194 W effective
                  Gradient = 8.1% → θ = 4.63°

                  Solving for velocity: v = 2.75 m/s = 9.9 km/h
                  Time = 13,800 m ÷ 2.75 m/s = 5,018 s = 1:23:38
                </div>
              </div>
            </div>
          </div>

          <!-- Constants Used -->
          <div>
            <h3 class="font-medium text-gray-900 mb-2">Assumptions</h3>
            <ul class="text-sm text-gray-600 space-y-1">
              <li>• Drivetrain efficiency: 97%</li>
              <li>• Rolling resistance coefficient (Crr): 0.004 (good road surface)</li>
              <li>• Aerodynamic drag area (CdA): 0.35 m² (climbing on hoods)</li>
              <li>• Air density: 1.2 kg/m³ (sea level)</li>
              <li>• Constant gradient throughout climb</li>
            </ul>
          </div>
        </div>
      </details>
    </section>

    <!-- Gearing Analysis -->
    <section class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Gearing Analysis</h2>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <!-- Chainring Select -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Chainring</label>
          <select id="chainringSelect" class="w-full rounded-lg border border-gray-300 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500">
            <option value="53-39">53/39 (Standard)</option>
            <option value="52-36">52/36 (Semi-Compact)</option>
            <option value="50-34" selected>50/34 (Compact)</option>
            <option value="48-35">48/35</option>
            <option value="48-32">48/32 (Gravel)</option>
            <option value="46-33">46/33</option>
            <option value="46-30">46/30 (Gravel)</option>
            <option value="42-32">42/32 (Gravel)</option>
            <option value="40-40">40 (1x)</option>
          </select>
        </div>

        <!-- Cassette Select -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Cassette</label>
          <select id="cassetteSelect" class="w-full rounded-lg border border-gray-300 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500">
            <option value="11-25">11-25 (11sp)</option>
            <option value="11-28">11-28 (11sp)</option>
            <option value="11-30">11-30 (12sp)</option>
            <option value="11-32">11-32 (11sp)</option>
            <option value="11-34" selected>11-34 (12sp)</option>
            <option value="11-36">11-36 (12sp)</option>
            <option value="10-33">10-33 (12sp)</option>
            <option value="10-36">10-36 (12sp)</option>
            <option value="11-42">11-42 (Gravel)</option>
            <option value="10-44">10-44 (Gravel)</option>
            <option value="10-52">10-52 (1x Gravel)</option>
          </select>
        </div>
      </div>

      <div class="bg-gray-50 rounded-lg p-4 mb-4 border border-gray-200">
        <div class="text-sm text-gray-600">
          At your calculated climbing speed of <span class="font-semibold text-gray-900" id="gearSpeed">9.9 km/h</span>,
          here are the cadences you'd need in each gear:
        </div>
      </div>

      <!-- Gear Table -->
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b border-gray-200">
              <th class="text-left py-3 px-2 font-medium text-gray-700">Gear</th>
              <th class="text-center py-3 px-2 font-medium text-gray-700">Ratio</th>
              <th class="text-center py-3 px-2 font-medium text-gray-700">Gear Inches</th>
              <th class="text-center py-3 px-2 font-medium text-gray-700">RPM Needed</th>
              <th class="text-center py-3 px-2 font-medium text-gray-700">Status</th>
            </tr>
          </thead>
          <tbody id="gearTableTooFast" class="hidden">
            <!-- Too fast gears (hidden by default) -->
          </tbody>
          <tbody id="gearTableIdeal">
            <!-- Ideal and OK gears -->
          </tbody>
          <tbody id="gearTableTooSlow" class="hidden">
            <!-- Too slow gears (hidden by default) -->
          </tbody>
        </table>
      </div>

      <!-- Show/Hide Buttons -->
      <div class="mt-3 flex flex-wrap gap-2">
        <button id="showTooFastBtn" class="hidden text-xs px-3 py-1.5 rounded-full border border-gray-300 text-gray-600 hover:bg-gray-50 transition-colors">
          Show <span id="tooFastCount">0</span> too fast gears
        </button>
        <button id="showTooSlowBtn" class="hidden text-xs px-3 py-1.5 rounded-full border border-gray-300 text-gray-600 hover:bg-gray-50 transition-colors">
          Show <span id="tooSlowCount">0</span> too slow gears
        </button>
      </div>

      <!-- Legend -->
      <div class="mt-4 flex flex-wrap gap-4 text-sm">
        <div class="flex items-center gap-2">
          <span class="w-3 h-3 rounded-full bg-green-500"></span>
          <span class="text-gray-600">Ideal (70-95 RPM)</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="w-3 h-3 rounded-full bg-yellow-500"></span>
          <span class="text-gray-600">Acceptable (60-70 or 95-110 RPM)</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="w-3 h-3 rounded-full bg-red-500"></span>
          <span class="text-gray-600">Difficult (&lt;60 or &gt;110 RPM)</span>
        </div>
      </div>

      <!-- Gear Inches Explanation -->
      <details class="mt-6 group">
        <summary class="flex items-center gap-2 text-sm text-gray-600 cursor-pointer">
          <svg class="w-4 h-4 transition-transform group-open:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
          What are gear inches?
        </summary>
        <div class="mt-2 p-4 bg-gray-50 rounded-lg text-sm text-gray-600">
          <p class="mb-2"><strong>Gear inches</strong> represent the equivalent wheel diameter of a direct-drive (fixed gear) bicycle with the same gear ratio. It's calculated as:</p>
          <p class="font-mono bg-white p-2 rounded mb-2">Gear Inches = (Chainring ÷ Cog) × Wheel Diameter (27")</p>
          <p>Lower gear inches = easier to pedal, higher cadence needed for same speed.<br>
          Higher gear inches = harder to pedal, lower cadence for same speed.</p>
        </div>
      </details>
    </section>

    <!-- Footer -->
    <footer class="mt-8 text-center text-sm text-gray-500">
      <p>Data sources: <a href="https://climbfinder.com" class="text-orange-600 hover:underline">ClimbFinder</a>,
        <a href="https://pjammcycling.com" class="text-orange-600 hover:underline">PJAMM Cycling</a></p>
      <p class="mt-1">Formulas based on <a href="https://www.gribble.org/cycling/power_v_speed.html" class="text-orange-600 hover:underline">cycling physics models</a></p>
    </footer>
  </div>

  <script>
    // ===== CLIMB DATA =====
    const climbs = {
      'alpe-dhuez': {
        name: "Alpe d'Huez",
        location: "Isère, French Alps",
        distance: 13.8, // km
        elevation: 1122, // m
        gradient: 8.1, // %
        category: "HC"
      },
      'galibier': {
        name: "Col du Galibier",
        location: "Savoie, French Alps",
        distance: 18.1,
        elevation: 1245,
        gradient: 6.9,
        category: "HC"
      },
      'haleakala': {
        name: "Haleakala",
        location: "Maui, Hawaii, USA",
        distance: 57,
        elevation: 3080,
        gradient: 5.4,
        category: "HC"
      },
      'ventoux': {
        name: "Mont Ventoux",
        location: "Provence, France (via Bédoin)",
        distance: 21.5,
        elevation: 1609,
        gradient: 7.6,
        category: "HC"
      },
      'tourmalet': {
        name: "Col du Tourmalet",
        location: "Hautes-Pyrénées, France",
        distance: 17.1,
        elevation: 1124,
        gradient: 7.4,
        category: "HC"
      }
    };

    // ===== GEARING DATA =====
    const chainrings = {
      '53-39': [53, 39],
      '52-36': [52, 36],
      '50-34': [50, 34],
      '48-35': [48, 35],
      '48-32': [48, 32],
      '46-33': [46, 33],
      '46-30': [46, 30],
      '42-32': [42, 32],
      '40-40': [40]  // 1x setup
    };

    // Common cassettes with actual cog teeth
    const cassettes = {
      '11-25': [11, 12, 13, 14, 15, 16, 17, 19, 21, 23, 25],
      '11-28': [11, 12, 13, 14, 15, 17, 19, 21, 23, 25, 28],
      '11-30': [11, 12, 13, 14, 15, 16, 17, 19, 21, 24, 27, 30],
      '11-32': [11, 12, 13, 14, 15, 17, 19, 21, 24, 27, 30, 32],
      '11-34': [11, 12, 13, 14, 15, 17, 19, 21, 24, 27, 30, 34],
      '11-36': [11, 12, 13, 14, 15, 17, 19, 21, 24, 28, 32, 36],
      '10-33': [10, 11, 12, 13, 14, 15, 17, 19, 21, 24, 28, 33],
      '10-36': [10, 11, 12, 13, 15, 17, 19, 21, 24, 28, 32, 36],
      '11-42': [11, 13, 15, 17, 19, 21, 24, 28, 32, 37, 42],
      '10-44': [10, 12, 14, 16, 18, 21, 24, 28, 32, 38, 44],
      '10-52': [10, 12, 14, 16, 18, 21, 24, 28, 33, 42, 52]
    };

    // Current selected cassette cogs
    let currentCassette = [11, 12, 13, 14, 15, 17, 19, 21, 24, 27, 30, 34];

    // Track show/hide state for gear sections
    let showTooFast = false;
    let showTooSlow = false;

    // Track custom climb state - which fields have been manually edited
    let customClimbEdited = { distance: false, elevation: false, gradient: false };
    let lastEditedField = null;

    // ===== PHYSICS CONSTANTS =====
    const GRAVITY = 9.81;
    const CRR = 0.004; // Rolling resistance coefficient
    const CDA = 0.35; // Aerodynamic drag area (m²)
    const RHO = 1.2; // Air density (kg/m³)
    const EFFICIENCY = 0.97; // Drivetrain efficiency
    const WHEEL_DIAMETER = 27; // inches (700c with 25mm tire)

    // ===== STATE =====
    let currentUnit = 'kg'; // 'kg' or 'lb'

    // ===== UTILITY FUNCTIONS =====
    const lbToKg = (lb) => lb * 0.453592;
    const kgToLb = (kg) => kg * 2.20462;

    function formatTime(seconds) {
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const secs = Math.floor(seconds % 60);

      if (hours > 0) {
        return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
      }
      return `${minutes}:${secs.toString().padStart(2, '0')}`;
    }

    function getPwrCategory(wkg) {
      if (wkg >= 6.0) return "World-class professional";
      if (wkg >= 5.0) return "Professional / Elite";
      if (wkg >= 4.0) return "Very strong amateur / Cat 1-2";
      if (wkg >= 3.5) return "Strong amateur / Cat 3";
      if (wkg >= 3.0) return "Good fitness / Cat 4-5";
      if (wkg >= 2.5) return "Recreational rider";
      return "Beginner";
    }

    // ===== CALCULATION FUNCTIONS =====
    function calculateClimbTime(powerWatts, totalMassKg, climb) {
      const distanceM = climb.distance * 1000;
      const gradientDecimal = climb.gradient / 100;
      const theta = Math.atan(gradientDecimal);

      // Effective power after drivetrain losses
      const effectivePower = powerWatts * EFFICIENCY;

      // Force components (excluding aerodynamic which depends on velocity)
      const gravityForce = totalMassKg * GRAVITY * Math.sin(theta);
      const rollingForce = CRR * totalMassKg * GRAVITY * Math.cos(theta);
      const staticForce = gravityForce + rollingForce;

      // Solve cubic equation: 0.5 * CDA * RHO * v³ + staticForce * v - effectivePower = 0
      // Using Newton-Raphson iteration
      let velocity = effectivePower / staticForce; // Initial guess (ignoring aero)

      for (let i = 0; i < 20; i++) {
        const aeroForce = 0.5 * CDA * RHO * velocity * velocity;
        const totalForce = staticForce + aeroForce;
        const powerNeeded = totalForce * velocity;

        const f = powerNeeded - effectivePower;
        const fPrime = staticForce + 1.5 * CDA * RHO * velocity * velocity;

        const delta = f / fPrime;
        velocity -= delta;

        if (Math.abs(delta) < 0.0001) break;
      }

      const timeSeconds = distanceM / velocity;
      const avgSpeedKmh = velocity * 3.6;

      return { timeSeconds, avgSpeedKmh, velocity };
    }

    function calculateGearInches(chainring, cog) {
      return (chainring / cog) * WHEEL_DIAMETER;
    }

    function calculateCadence(speedKmh, gearInches) {
      const speedMph = speedKmh * 0.621371;
      return (speedMph * 63360) / (gearInches * Math.PI * 60);
    }

    function getRpmStatus(rpm) {
      if (rpm >= 70 && rpm <= 95) return { class: 'text-green-600', bg: 'bg-green-500', label: 'Ideal' };
      if ((rpm >= 60 && rpm < 70) || (rpm > 95 && rpm <= 110)) return { class: 'text-yellow-600', bg: 'bg-yellow-500', label: 'OK' };
      return { class: 'text-red-600', bg: 'bg-red-500', label: rpm < 60 ? 'Too slow' : 'Too fast' };
    }

    // ===== UI UPDATE FUNCTIONS =====
    function getInputValues() {
      let riderWeight = parseFloat(document.getElementById('riderWeight').value) || 70;
      let bikeWeight = parseFloat(document.getElementById('bikeWeight').value) || 8;
      const power = parseFloat(document.getElementById('power').value) || 200;

      // Convert to kg if currently in lb mode
      if (currentUnit === 'lb') {
        riderWeight = lbToKg(riderWeight);
        bikeWeight = lbToKg(bikeWeight);
      }

      return { riderWeight, bikeWeight, power, totalMass: riderWeight + bikeWeight };
    }

    function toggleUnits() {
      const riderInput = document.getElementById('riderWeight');
      const bikeInput = document.getElementById('bikeWeight');
      const riderUnitSpan = document.getElementById('riderWeightUnit');
      const bikeUnitSpan = document.getElementById('bikeWeightUnit');
      const kgLabel = document.getElementById('kgLabel');
      const lbLabel = document.getElementById('lbLabel');
      const toggleKnob = document.getElementById('toggleKnob');

      let riderValue = parseFloat(riderInput.value) || 0;
      let bikeValue = parseFloat(bikeInput.value) || 0;

      if (currentUnit === 'kg') {
        // Convert kg to lb
        riderValue = kgToLb(riderValue);
        bikeValue = kgToLb(bikeValue);
        currentUnit = 'lb';

        // Update UI
        riderUnitSpan.textContent = 'lb';
        bikeUnitSpan.textContent = 'lb';
        kgLabel.classList.remove('text-orange-600');
        kgLabel.classList.add('text-gray-400');
        lbLabel.classList.remove('text-gray-400');
        lbLabel.classList.add('text-orange-600');
        toggleKnob.classList.remove('translate-x-0');
        toggleKnob.classList.add('translate-x-5');
      } else {
        // Convert lb to kg
        riderValue = lbToKg(riderValue);
        bikeValue = lbToKg(bikeValue);
        currentUnit = 'kg';

        // Update UI
        riderUnitSpan.textContent = 'kg';
        bikeUnitSpan.textContent = 'kg';
        lbLabel.classList.remove('text-orange-600');
        lbLabel.classList.add('text-gray-400');
        kgLabel.classList.remove('text-gray-400');
        kgLabel.classList.add('text-orange-600');
        toggleKnob.classList.remove('translate-x-5');
        toggleKnob.classList.add('translate-x-0');
      }

      // Update input values with converted amounts
      riderInput.value = riderValue.toFixed(1);
      bikeInput.value = bikeValue.toFixed(1);

      // Recalculate everything
      updateAll();
    }

    function updatePowerToWeight() {
      const { riderWeight, power } = getInputValues();
      const wkg = power / riderWeight;

      document.getElementById('powerToWeight').textContent = `${wkg.toFixed(2)} W/kg`;
      document.getElementById('pwrCategory').textContent = getPwrCategory(wkg);

      // Update formula display
      document.getElementById('pwrFormula').textContent =
        `W/kg = ${power} W ÷ ${riderWeight.toFixed(1)} kg = ${wkg.toFixed(2)} W/kg`;
    }

    function getCustomClimb() {
      const distance = parseFloat(document.getElementById('customDistance').value) || 0;
      const elevation = parseFloat(document.getElementById('customElevation').value) || 0;
      const gradient = parseFloat(document.getElementById('customGradient').value) || 0;

      return {
        name: "Custom Climb",
        location: "Your route",
        distance,
        elevation,
        gradient,
        category: "Custom"
      };
    }

    function calculateCustomClimbField(changedField) {
      const distanceInput = document.getElementById('customDistance');
      const elevationInput = document.getElementById('customElevation');
      const gradientInput = document.getElementById('customGradient');
      const hintEl = document.getElementById('customCalcHint');

      let distance = parseFloat(distanceInput.value) || 0;
      let elevation = parseFloat(elevationInput.value) || 0;
      let gradient = parseFloat(gradientInput.value) || 0;

      // Mark the changed field as edited
      customClimbEdited[changedField] = true;
      lastEditedField = changedField;

      // Count how many fields have values
      const hasDistance = distance > 0;
      const hasElevation = elevation > 0;
      const hasGradient = gradient > 0;
      const filledCount = [hasDistance, hasElevation, hasGradient].filter(Boolean).length;

      // If we have exactly 2 values, calculate the third
      if (filledCount >= 2) {
        // Determine which field to calculate based on what was just edited
        // The field to calculate is the one that wasn't recently edited

        if (hasDistance && hasElevation && changedField !== 'gradient') {
          // Calculate gradient from distance and elevation
          // gradient = (elevation / (distance * 1000)) * 100
          // But we need to account for the fact that distance is horizontal
          // For simplicity: gradient ≈ elevation / (distance * 1000) * 100
          const calculatedGradient = (elevation / (distance * 1000)) * 100;
          gradientInput.value = calculatedGradient.toFixed(1);
          hintEl.textContent = `Gradient calculated from distance and elevation`;
          hintEl.classList.remove('hidden');
        } else if (hasDistance && hasGradient && changedField !== 'elevation') {
          // Calculate elevation from distance and gradient
          // elevation = distance * 1000 * (gradient / 100)
          const calculatedElevation = distance * 1000 * (gradient / 100);
          elevationInput.value = Math.round(calculatedElevation);
          hintEl.textContent = `Elevation calculated from distance and gradient`;
          hintEl.classList.remove('hidden');
        } else if (hasElevation && hasGradient && changedField !== 'distance') {
          // Calculate distance from elevation and gradient
          // distance = elevation / (gradient / 100) / 1000
          const calculatedDistance = elevation / (gradient / 100) / 1000;
          distanceInput.value = calculatedDistance.toFixed(1);
          hintEl.textContent = `Distance calculated from elevation and gradient`;
          hintEl.classList.remove('hidden');
        }
      } else {
        hintEl.classList.add('hidden');
      }

      // Trigger recalculation
      updateClimbInfo();
    }

    function updateClimbInfo() {
      const climbId = document.getElementById('climbSelect').value;
      const customInputsEl = document.getElementById('customClimbInputs');
      const climbHeader = document.getElementById('climbHeader');

      // Show/hide custom inputs
      if (climbId === 'custom') {
        customInputsEl.classList.remove('hidden');
        climbHeader.classList.add('hidden');
      } else {
        customInputsEl.classList.add('hidden');
        climbHeader.classList.remove('hidden');
      }

      // Get climb data (either preset or custom)
      let climb;
      if (climbId === 'custom') {
        climb = getCustomClimb();

        // Check if we have enough data for calculations
        if (climb.distance <= 0 || climb.elevation <= 0 || climb.gradient <= 0) {
          document.getElementById('climbDistance').textContent = climb.distance > 0 ? climb.distance.toFixed(1) : '—';
          document.getElementById('climbElevation').textContent = climb.elevation > 0 ? climb.elevation.toLocaleString() : '—';
          document.getElementById('climbGradient').textContent = climb.gradient > 0 ? climb.gradient.toFixed(1) : '—';
          document.getElementById('estimatedTime').textContent = '—:—:—';
          document.getElementById('avgSpeed').textContent = '— km/h';
          document.getElementById('climbCategory').textContent = 'Custom';
          document.getElementById('climbFormula').textContent = 'Enter distance, elevation, and gradient to see calculations.';
          document.getElementById('gearSpeed').textContent = '— km/h';
          return;
        }
      } else {
        climb = climbs[climbId];
      }

      const { riderWeight, bikeWeight, power, totalMass } = getInputValues();

      // Update climb details
      if (climbId !== 'custom') {
        document.getElementById('climbName').textContent = climb.name;
        document.getElementById('climbLocation').textContent = climb.location;
      }
      document.getElementById('climbCategory').textContent = climb.category;
      document.getElementById('climbDistance').textContent = climb.distance.toFixed(1);
      document.getElementById('climbElevation').textContent = climb.elevation.toLocaleString();
      document.getElementById('climbGradient').textContent = climb.gradient.toFixed(1);

      // Calculate time
      const { timeSeconds, avgSpeedKmh, velocity } = calculateClimbTime(power, totalMass, climb);

      document.getElementById('estimatedTime').textContent = formatTime(timeSeconds);
      document.getElementById('avgSpeed').textContent = `${avgSpeedKmh.toFixed(1)} km/h`;

      // Update formula display
      const theta = Math.atan(climb.gradient / 100);
      const thetaDeg = theta * 180 / Math.PI;
      const effectivePower = power * EFFICIENCY;

      document.getElementById('climbFormula').textContent =
`Total mass = ${riderWeight.toFixed(1)} + ${bikeWeight.toFixed(1)} = ${totalMass.toFixed(1)} kg
Power input = ${power} W × ${EFFICIENCY} = ${effectivePower.toFixed(0)} W effective
Gradient = ${climb.gradient}% → θ = ${thetaDeg.toFixed(2)}°

Solving for velocity: v = ${velocity.toFixed(2)} m/s = ${avgSpeedKmh.toFixed(1)} km/h
Time = ${(climb.distance * 1000).toLocaleString()} m ÷ ${velocity.toFixed(2)} m/s = ${timeSeconds.toFixed(0)} s = ${formatTime(timeSeconds)}`;

      // Update gear speed display and table
      document.getElementById('gearSpeed').textContent = `${avgSpeedKmh.toFixed(1)} km/h`;
      updateGearTable(avgSpeedKmh);
    }

    function updateCurrentCassette() {
      const cassetteKey = document.getElementById('cassetteSelect').value;
      currentCassette = cassettes[cassetteKey];
    }

    function updateGearTable(speedKmh) {
      const chainringId = document.getElementById('chainringSelect').value;
      const selectedChainrings = chainrings[chainringId];

      const tbodyTooFast = document.getElementById('gearTableTooFast');
      const tbodyIdeal = document.getElementById('gearTableIdeal');
      const tbodyTooSlow = document.getElementById('gearTableTooSlow');

      // Build all gear combinations, sorted by gear inches (easiest first for climbing)
      const gearCombos = [];

      for (const chainring of selectedChainrings) {
        for (const cog of currentCassette) {
          const gearInches = calculateGearInches(chainring, cog);
          const ratio = chainring / cog;
          const rpm = calculateCadence(speedKmh, gearInches);

          gearCombos.push({ chainring, cog, ratio, gearInches, rpm });
        }
      }

      // Sort by gear inches (lowest first - easiest gears at top)
      gearCombos.sort((a, b) => a.gearInches - b.gearInches);

      // Filter to show only the most useful climbing gears (small chainring)
      const smallChainring = Math.min(...selectedChainrings);
      const climbingGears = gearCombos.filter(g => g.chainring === smallChainring);

      // Separate gears into categories
      const tooFastGears = [];
      const idealGears = [];
      const tooSlowGears = [];

      climbingGears.forEach(gear => {
        const status = getRpmStatus(gear.rpm);
        if (gear.rpm > 110) {
          tooFastGears.push({ ...gear, status });
        } else if (gear.rpm < 60) {
          tooSlowGears.push({ ...gear, status });
        } else {
          idealGears.push({ ...gear, status });
        }
      });

      // Helper to generate row HTML
      const generateRow = (gear, faded = false) => {
        const opacity = faded ? 'opacity-50' : '';
        return `
          <tr class="border-b border-gray-100 hover:bg-gray-50 ${opacity}">
            <td class="py-2 px-2 font-medium">${gear.chainring}×${gear.cog}</td>
            <td class="py-2 px-2 text-center">${gear.ratio.toFixed(2)}</td>
            <td class="py-2 px-2 text-center">${gear.gearInches.toFixed(1)}"</td>
            <td class="py-2 px-2 text-center font-semibold ${gear.status.class}">${Math.round(gear.rpm)}</td>
            <td class="py-2 px-2 text-center">
              <span class="inline-flex items-center gap-1">
                <span class="w-2 h-2 rounded-full ${gear.status.bg}"></span>
                <span class="text-xs text-gray-600">${gear.status.label}</span>
              </span>
            </td>
          </tr>
        `;
      };

      // Generate table HTML for each section
      tbodyTooFast.innerHTML = tooFastGears.map(g => generateRow(g, true)).join('');
      tbodyIdeal.innerHTML = idealGears.map(g => generateRow(g, false)).join('');
      tbodyTooSlow.innerHTML = tooSlowGears.map(g => generateRow(g, true)).join('');

      // Update show/hide buttons
      const showTooFastBtn = document.getElementById('showTooFastBtn');
      const showTooSlowBtn = document.getElementById('showTooSlowBtn');
      const tooFastCountSpan = document.getElementById('tooFastCount');
      const tooSlowCountSpan = document.getElementById('tooSlowCount');

      // Too Fast button
      if (tooFastGears.length > 0) {
        showTooFastBtn.classList.remove('hidden');
        tooFastCountSpan.textContent = tooFastGears.length;
        if (showTooFast) {
          tbodyTooFast.classList.remove('hidden');
          showTooFastBtn.textContent = `Hide ${tooFastGears.length} too fast gear${tooFastGears.length > 1 ? 's' : ''}`;
        } else {
          tbodyTooFast.classList.add('hidden');
          showTooFastBtn.innerHTML = `Show <span id="tooFastCount">${tooFastGears.length}</span> too fast gear${tooFastGears.length > 1 ? 's' : ''}`;
        }
      } else {
        showTooFastBtn.classList.add('hidden');
        tbodyTooFast.classList.add('hidden');
      }

      // Too Slow button
      if (tooSlowGears.length > 0) {
        showTooSlowBtn.classList.remove('hidden');
        tooSlowCountSpan.textContent = tooSlowGears.length;
        if (showTooSlow) {
          tbodyTooSlow.classList.remove('hidden');
          showTooSlowBtn.textContent = `Hide ${tooSlowGears.length} too slow gear${tooSlowGears.length > 1 ? 's' : ''}`;
        } else {
          tbodyTooSlow.classList.add('hidden');
          showTooSlowBtn.innerHTML = `Show <span id="tooSlowCount">${tooSlowGears.length}</span> too slow gear${tooSlowGears.length > 1 ? 's' : ''}`;
        }
      } else {
        showTooSlowBtn.classList.add('hidden');
        tbodyTooSlow.classList.add('hidden');
      }
    }

    function getSelectedClimb() {
      const climbId = document.getElementById('climbSelect').value;
      if (climbId === 'custom') {
        return getCustomClimb();
      }
      return climbs[climbId];
    }

    function toggleTooFast() {
      showTooFast = !showTooFast;
      const climb = getSelectedClimb();
      if (climb.distance <= 0 || climb.gradient <= 0) return;
      const { power, totalMass } = getInputValues();
      const { avgSpeedKmh } = calculateClimbTime(power, totalMass, climb);
      updateGearTable(avgSpeedKmh);
    }

    function toggleTooSlow() {
      showTooSlow = !showTooSlow;
      const climb = getSelectedClimb();
      if (climb.distance <= 0 || climb.gradient <= 0) return;
      const { power, totalMass } = getInputValues();
      const { avgSpeedKmh } = calculateClimbTime(power, totalMass, climb);
      updateGearTable(avgSpeedKmh);
    }

    function updateAll() {
      updatePowerToWeight();
      updateClimbInfo();
    }

    // ===== EVENT LISTENERS =====
    document.getElementById('riderWeight').addEventListener('input', updateAll);
    document.getElementById('bikeWeight').addEventListener('input', updateAll);
    document.getElementById('power').addEventListener('input', updateAll);
    document.getElementById('unitToggle').addEventListener('click', toggleUnits);
    document.getElementById('climbSelect').addEventListener('change', updateAll);

    // Gearing selects
    const updateGearingFromSelects = () => {
      const climb = getSelectedClimb();
      if (climb.distance <= 0 || climb.gradient <= 0) return;
      const { power, totalMass } = getInputValues();
      const { avgSpeedKmh } = calculateClimbTime(power, totalMass, climb);
      updateGearTable(avgSpeedKmh);
    };

    document.getElementById('chainringSelect').addEventListener('change', updateGearingFromSelects);

    document.getElementById('cassetteSelect').addEventListener('change', () => {
      updateCurrentCassette();
      updateGearingFromSelects();
    });

    // Show/hide buttons for gear table
    document.getElementById('showTooFastBtn').addEventListener('click', toggleTooFast);
    document.getElementById('showTooSlowBtn').addEventListener('click', toggleTooSlow);

    // Custom climb inputs
    document.getElementById('customDistance').addEventListener('input', () => calculateCustomClimbField('distance'));
    document.getElementById('customElevation').addEventListener('input', () => calculateCustomClimbField('elevation'));
    document.getElementById('customGradient').addEventListener('input', () => calculateCustomClimbField('gradient'));

    // ===== INITIALIZE =====
    updateCurrentCassette(); // Initialize cassette from default selection
    updateAll();
  </script>
</body>
</html>
